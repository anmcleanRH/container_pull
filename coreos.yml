---
- hosts: localhost
  gather_facts: True
  tags: ocp
  vars:
    # coreos boot media doesnt have point releases, once 4.3 is out its not updated till 4.4
    coreos_ver: '4.5'
    ocp_tag: '4.5.1'
    ocp_ver: '4.5'
    bin_path: "{{ import_root }}/bin"
    registry_path: "{{ import_root}}/registry"
    # get pull secret from https://cloud.redhat.com/openshift/install/metal/user-provisioned
    quay_creds: "/etc/ansible/playbooks/all.json"
    mirror_reg: 'localhost:7000'
    operator_orgs:
      - 'redhat-operators'
      - 'community-operators'
  pre_tasks:
    - name: facts
      setup:
      tags: always
  tasks:
    - name: create paths
      file:
        path: "{{ item }}"
        state: directory
        mode: 0755
      loop:
        - "{{ bin_path }}"
        - "{{ import_root }}/ocp-release"
        - "{{ import_root }}/olm"
        - "{{ import_root }}/registry"
        - "{{ import_root }}/wget"
        - "{{ registry_path }}"
      tags: init
    - name: grab coreos media
      command: "/bin/wget --recursive --directory-prefix {{import_root}}/wget --cut-dirs 1 -R 'index.html*,*nightly*' -np {{ item }}"
      loop:
        - "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{ coreos_ver }}/latest/"
        - "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{ ocp_ver }}/latest/"
        - "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/{{ ocp_tag }}/"
      tags: wget
    - name: extract binary
      unarchive:
        src: "{{ item }}"
        dest: "{{bin_path}}"
      loop:
        - "{{import_root}}/wget/mirror.openshift.com/openshift-v4/clients/ocp/{{ocp_tag}}/openshift-client-linux.tar.gz"
        - "{{import_root}}/wget/mirror.openshift.com/openshift-v4/clients/ocp/{{ocp_tag}}/openshift-install-linux.tar.gz"
      tags: binary
    - name: get ocp4 images
      # the oc binary needs to be >=4.3 for --to-dir
      shell: "{{bin_path}}/oc adm -a {{quay_creds}} release mirror  quay.io/openshift-release-dev/ocp-release:{{ocp_tag}}-x86_64 --to-dir {{import_root}}/ocp-release/"
      tags: 
        - ocp-release
    - name: ensure mirror reg is running
      #initialised (certs etc) externally mainly for reference here, hopefully can be deprecated in favour of --to-dir for catalog mirrors
      shell: "podman run --name mirror-registry -p 7000:5000  -v {{registry_path}}/data:/var/lib/registry:z  -v {{registry_path}}/auth:/auth:z  -e 'REGISTRY_AUTH=htpasswd' -e 'REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm' -e 'REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd' -v {{registry_path}}/certs:/certs:z -e 'REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt' -e 'REGISTRY_HTTP_TLS_KEY=/certs/domain.key' -d docker.io/library/registry:2"
      failed_when: False
      when: False
      tags: registry
    - name: create operator catalog
#  /var/lib/import/bin/oc adm catalog build --appregistry-org redhat-operators -a /etc/ansible/playbooks/all.json --to=registry.home:7000/mirror/redhat-operators:4.4
      shell: 
        cmd: "{{bin_path}}/oc adm catalog build --appregistry-org redhat-operators -a {{quay_creds}} --to  {{mirror_reg}}/mirror/redhat-operators:{{ocp_ver}}"
        chdir: "{{import_root}}/olm"
      tags: olm
    - name: mirror catalog refs
# /var/lib/import/bin/oc adm catalog mirror registry.home:7000/mirror/redhat-operators:4.4 registry.home:7000 -a /etc/ansible/playbooks/all.json
      shell: "{{bin_path}}/oc adm catalog mirror {{mirror_reg}}/mirror/redhat-operators:{{ocp_ver}} {{mirror_reg}} -a {{quay_creds}} "
      tags: olm
    - name: clear old export
      shell: "rm {{export_dir}}/coreos*"
      ignore_errors: True
      tags: tar
    - name: archive it
      archive:
        path: 
          - "{{import_root}}/ocp-release"
          - "{{import_root}}/olm"
          - "{{import_root}}/registry"
          - "{{import_root}}/wget"
          - "{{registry_path}}"
        dest: "{{export_dir}}/ocp-{{ansible_date_time.date}}.tar"
        format: tar
        remove: False
      tags: tar


